{% schema %}
{
  "name": "Quick View Modal",
  "target": "body",
  "settings": [
    {
      "type": "text",
      "id": "trigger_selector",
      "label": "Tetikleyici CSS Sınıfı",
      "default": ".js-quick-view-trigger"
    },
    {
      "type": "color",
      "id": "btn_color",
      "label": "Buton Rengi",
      "default": "#111111"
    }
  ]
}
{% endschema %}

<div id="quick-view-modal" class="qv-modal" aria-hidden="true" style="display: none;">
  <div class="qv-overlay" data-close></div>
  <div class="qv-container">
    <div class="qv-drag-handle" data-close></div>
    <button class="qv-close" data-close>
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M18 6L6 18M6 6l12 12"></path></svg>
    </button>
    
    <div class="qv-content">
       <div class="qv-loading">
          <div class="qv-spinner"></div>
       </div>
       
       <div class="qv-body" style="display:none;">
          <!-- Desktop: Image Left with Arrows -->
          <div class="qv-image-col">
             <div class="qv-image-wrapper">
                 <button class="qv-arrow qv-prev" id="qv-prev-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
                 </button>
                 <img id="qv-main-image" src="" alt="Ürün Görseli">
                 <button class="qv-arrow qv-next" id="qv-next-btn">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                 </button>
             </div>
          </div>
          
          <!-- Shared Info Col -->
          <div class="qv-info-col">
             
             <!-- Mobile Header -->
             <div class="qv-mobile-header">
                 <div class="qv-mob-img-wrap">
                    <img id="qv-mobile-image" src="" alt="">
                 </div>
                 <div class="qv-mob-info">
                    <div id="qv-vendor-mob" class="qv-vendor-tag"></div>
                    <div id="qv-title-mob" class="qv-product-title"></div>
                    <div class="qv-price-wrapper">
                         <span class="qv-price"></span>
                         <span class="qv-compare-price"></span>
                    </div>
                 </div>
             </div>

             <!-- Desktop Header -->
             <div class="qv-desktop-header">
                 <span id="qv-vendor" class="qv-vendor-tag"></span>
                 <h2 id="qv-title" class="qv-product-title"></h2>
                 <div class="qv-price-wrapper">
                    <span class="qv-price"></span>
                    <span class="qv-compare-price"></span>
                 </div>
             </div>

             <form id="qv-form">
                <input type="hidden" name="id" id="qv-variant-id">
                <div id="qv-options" class="qv-options"></div>

                <div class="qv-shipping-box">
                   <div class="qv-shipping-title">TAHMİNİ KARGOYA TESLİM</div>
                   <div id="qv-delivery-date" class="qv-shipping-date"></div>
                </div>

                <div class="qv-footer-actions">
                   <button type="submit" id="qv-add-btn" class="qv-add-btn">SEPETE EKLE</button>
                   <!-- Details Button (Replaces Wishlist) -->
                   <a href="#" class="qv-details-btn" id="qv-details-btn" aria-label="Ürün Detayına Git">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                   </a>
                </div>
             </form>

             <!-- Removed text link as per request pattern -->
             <!-- <div class="qv-details-link-wrapper"><a id="qv-full-details" href="#" class="qv-details-link">Ürün Detayına Git &rsaquo;</a></div> -->
          </div>
       </div>
    </div>
  </div>
</div>

<style>
/* Core & Reset */
.qv-modal { font-family: 'Inter', system-ui, -apple-system, sans-serif; color: #111; line-height: 1.4; }
.qv-modal * { box-sizing: border-box; }

/* Modal Positioning */
.qv-modal { 
    position: fixed; z-index: 2147483647; top: 0; left: 0; width: 100%; height: 100%; 
    display: flex; align-items: center; justify-content: center; 
    opacity: 0; visibility: hidden; transition: opacity 0.2s, visibility 0.2s; 
}
.qv-modal.open { opacity: 1; visibility: visible; display: flex !important; }

.qv-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }

.qv-container {
    position: relative; background: #fff; width: 950px; max-width: 95%; height: auto; min-height: 550px; max-height: 90vh;
    border-radius: 8px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); display: flex; overflow: hidden;
}
.qv-close { position: absolute; top: 15px; right: 15px; background: none; border: none; cursor: pointer; color: #555; z-index: 20; padding: 5px; }

/* Image Col */
.qv-image-col { width: 55%; background: #f9f9f9; padding: 0; display: flex; align-items: center; justify-content: center; position: relative; }
.qv-image-wrapper { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; }
.qv-image-col img { width: 100%; height: 100%; object-fit: contain; max-height: 600px; padding: 20px; mix-blend-mode: multiply; }

/* Arrows */
.qv-arrow { 
    position: absolute; top: 50%; transform: translateY(-50%); 
    background: rgba(255,255,255,0.9); border: 1px solid #ddd; border-radius: 50%; 
    width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; cursor: pointer; 
    color: #333; z-index: 5; transition: all 0.2s; box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}
.qv-arrow:hover { background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateY(-50%) scale(1.05); }
.qv-prev { left: 20px; }
.qv-next { right: 20px; }

/* Info Col */
.qv-info-col { width: 45%; padding: 40px; display: flex; flex-direction: column; overflow-y: auto; }

/* Typography */
.qv-vendor-tag { display: inline-block; background: #f4f4f4; color: #666; font-size: 11px; font-weight: 700; padding: 4px 8px; border-radius: 2px; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
.qv-product-title { font-size: 26px; font-weight: 700; margin: 0 0 10px 0; line-height: 1.2; color: #000; }
.qv-price-wrapper { display: flex; align-items: baseline; gap: 8px; font-size: 22px; font-weight: 700; color: #000; }
.qv-compare-price { font-size: 16px; text-decoration: line-through; color: #999; font-weight: 400; }

/* Swatches */
.qv-option-header { font-size: 13px; font-weight: 600; margin-bottom: 8px; color: #000; display: flex; gap: 5px; }
.qv-active-val { font-weight: 400; color: #666; }
.qv-option-group { margin-bottom: 20px; }
.qv-option-group.hidden { display: none; }

.qv-swatch-container { display: flex; flex-wrap: wrap; gap: 8px; }

/* UNIFIED SWATCH STYLE (Colors & Sizes both Boxes) */
.qv-swatch-rect { 
    height: 44px; min-width: 48px; padding: 0 15px; border: 1px solid #ddd; background: #fff;
    cursor: pointer; display: flex; align-items: center; justify-content: center;
    font-size: 13px; font-weight: 500; color: #333; transition: all 0.2s; border-radius: 2px;
    text-transform: uppercase;
}
.qv-swatch-rect:hover { border-color: #000; }
.qv-swatch-rect.selected { border-color: #000; background: #fff; color: #000; box-shadow: inset 0 0 0 1px #000, 0 2px 4px rgba(0,0,0,0.05); font-weight: 600; }
.qv-swatch-rect.disabled { opacity: 0.5; cursor: not-allowed; text-decoration: line-through; background: #f9f9f9; color: #aaa; }

/* Shipping */
.qv-shipping-box { background: #f8f8f8; padding: 15px; border-radius: 4px; text-align: center; margin-bottom: 24px; border: 1px solid #eee; }
.qv-shipping-title { font-size: 11px; text-transform: uppercase; color: #888; letter-spacing: 0.5px; margin-bottom: 4px; }
.qv-shipping-date { font-size: 14px; font-weight: 700; color: #333; }

/* Buttons */
.qv-footer-actions { display: flex; gap: 10px; }
.qv-add-btn { flex: 1; height: 52px; background: {{ block.settings.btn_color }}; color: #fff; border: none; font-weight: 700; cursor: pointer; border-radius: 2px; font-size: 14px; letter-spacing: 1px; text-transform: uppercase; }
.qv-add-btn:hover { opacity: 0.9; }
.qv-add-btn:disabled { background: #ccc; cursor: not-allowed; }

.qv-details-btn { 
    width: 52px; height: 52px; border: 1px solid #ddd; background: #fff; display: flex; align-items: center; justify-content: center; 
    cursor: pointer; border-radius: 2px; color: #333; transition: all 0.2s; text-decoration: none;
}
.qv-details-btn:hover { border-color: #000; color: #000; }

.qv-details-link-wrapper { margin-top: 16px; text-align: center; }
.qv-details-link { font-size: 13px; color: #666; text-decoration: underline; }

/* Spinner */
.qv-loading { position: absolute; inset:0; background:#fff; display: flex; align-items: center; justify-content: center; z-index: 50; }
.qv-spinner { width: 40px; height: 40px; border: 3px solid #eee; border-top-color: {{ block.settings.btn_color }}; border-radius: 50%; animation: spin 0.8s linear infinite; }

/* Headers visibility */
.qv-mobile-header { display: none; }
.qv-desktop-header { display: block; margin-bottom: 20px; }

/* MOBILE RESPONSIVE */
@media (max-width: 768px) {
    .qv-modal { align-items: flex-end; padding: 0; }
    .qv-container { 
        width: 100%; max-width: 100%; height: auto; max-height: 90vh; 
        border-radius: 12px 12px 0 0; 
        flex-direction: column;
        margin: 0; 
        box-shadow: 0 -5px 25px rgba(0,0,0,0.15);
    }
    .qv-close { display: none; }
    .qv-drag-handle { 
        display: block; width: 40px; height: 4px; background: #ddd; border-radius: 2px; 
        position: absolute; top: 8px; left: 50%; transform: translateX(-50%); z-index: 25; cursor: pointer;
    }

    .qv-image-col { display: none; }
    .qv-desktop-header { display: none; }
    
    /* FIX: Added huge bottom padding to clear the sticky button */
    .qv-info-col { width: 100%; padding: 24px 20px; padding-bottom: 100px; padding-top: 30px; overflow-y: scroll; -webkit-overflow-scrolling: touch; }
    .qv-info-col::-webkit-scrollbar { display: none; }
    
    .qv-mobile-header { display: flex; gap: 15px; margin-bottom: 24px; align-items: start; }
    .qv-mob-img-wrap { width: 90px; height: 110px; border-radius: 4px; overflow: hidden; background: #f4f4f4; flex-shrink: 0; }
    .qv-mob-img-wrap img { width: 100%; height: 100%; object-fit: cover; }
    .qv-mob-info { flex: 1; display: flex; flex-direction: column; justify-content: start; pt: 5px; }
    
    .qv-product-title { font-size: 18px; margin-bottom: 6px; }
    .qv-vendor-tag { font-size: 10px; margin-bottom: 6px; align-self: flex-start; }
    .qv-price-wrapper { font-size: 18px; }

    /* Buttons Sticky */
    .qv-footer-actions { position: absolute; bottom: 0; left: 0; right: 0; padding-top: 10px; background: #fff; padding: 15px 20px; border-top: 1px solid #eee; z-index: 10; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
}

@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const triggerSelector = "{{ block.settings.trigger_selector }}";
  const modal = document.getElementById('quick-view-modal');
  const overlay = modal.querySelector('.qv-overlay');
  const closeBtns = modal.querySelectorAll('[data-close]');
  let currentProduct = null;
  let currentImages = [];
  let currentImageIndex = 0;

  // --- Image Slider Logic ---
  const imgEl = document.getElementById('qv-main-image');
  const prevBtn = document.getElementById('qv-prev-btn');
  const nextBtn = document.getElementById('qv-next-btn');

  function updateMainImage(index) {
      if(!currentImages || currentImages.length === 0) return;
      if(index < 0) index = currentImages.length - 1;
      if(index >= currentImages.length) index = 0;
      currentImageIndex = index;
      
      let src = currentImages[currentImageIndex];
      if(src.startsWith('//')) src = 'https:' + src;
      imgEl.src = src;
  }

  if(prevBtn) prevBtn.onclick = (e) => { e.stopPropagation(); updateMainImage(currentImageIndex - 1); };
  if(nextBtn) nextBtn.onclick = (e) => { e.stopPropagation(); updateMainImage(currentImageIndex + 1); };

  // --- Click Listener ---
  document.body.addEventListener('click', (e) => {
      let trigger = e.target.closest(triggerSelector);
      if (!trigger) {
          const link = e.target.closest('a[href*="/products/"]');
          if (link && (link.classList.contains('js-quick-view-trigger') || link.dataset.quickView)) {
              trigger = link;
          }
      }

      if(trigger) {
          e.preventDefault(); e.stopPropagation();
          let handle = trigger.dataset.productHandle;
          if(!handle && trigger.href) {
              const parts = trigger.href.split('/products/');
              if(parts.length > 1) handle = parts[1].split('?')[0];
          }
          if(!handle && trigger.dataset.url) {
              const parts = trigger.dataset.url.split('/products/');
              if(parts.length > 1) handle = parts[1].split('?')[0];
          }
          if(handle) {
              openModal(handle);
          }
      }
  });

  closeBtns.forEach(b => b.addEventListener('click', closeModal));
  overlay.addEventListener('click', closeModal);
  
  // Drag handle close logic
  const dragHandle = modal.querySelector('.qv-drag-handle');
  if(dragHandle) dragHandle.addEventListener('click', closeModal);

  function openModal(handle) {
      modal.classList.add('open');
      modal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      
      modal.querySelector('.qv-loading').style.display = 'flex';
      modal.querySelector('.qv-body').style.display = 'none';
      
      fetch(`/products/${handle}.js`)
          .then(res => res.json())
          .then(renderProduct)
          .catch(err => { console.error(err); closeModal(); });
  }

  function closeModal() {
      modal.classList.remove('open');
      setTimeout(() => { if(!modal.classList.contains('open')) modal.style.display = 'none'; }, 200);
      document.body.style.overflow = '';
      currentProduct = null;
      currentImages = [];
  }

  function renderProduct(product) {
      currentProduct = product;
      
      // Images (All)
      currentImages = product.images || [product.featured_image];
      currentImageIndex = 0;
      updateMainImage(0);
      
      if(currentImages.length > 1) {
          prevBtn.style.display = 'flex';
          nextBtn.style.display = 'flex';
      } else {
          prevBtn.style.display = 'none';
          nextBtn.style.display = 'none';
      }

      // Basic Info
      const vendorText = product.vendor;
      const titleText = product.title;
      const productUrl = product.url;

      // UPDATE DETAILS BUTTON HREF
      const detailsBtn = document.getElementById('qv-details-btn');
      if(detailsBtn) detailsBtn.href = productUrl;

      // Desktop
      document.getElementById('qv-vendor').textContent = vendorText;
      document.getElementById('qv-title').textContent = titleText;
      
      // Mobile
      document.getElementById('qv-vendor-mob').textContent = vendorText;
      document.getElementById('qv-title-mob').textContent = titleText;
      
      // Initial Mobile Image
      let mobImg = product.featured_image || '';
      if(mobImg.startsWith('//')) mobImg = 'https:' + mobImg;
      document.getElementById('qv-mobile-image').src = mobImg;

      // Delivery
      const d1 = new Date(); d1.setDate(d1.getDate() + 3);
      const d2 = new Date(); d2.setDate(d2.getDate() + 6);
      const opts = { day: '2-digit', month: 'long' };
      let dateStr = `${d1.toLocaleDateString('tr-TR', opts)} - ${d2.toLocaleDateString('tr-TR', opts)}`;
      document.getElementById('qv-delivery-date').textContent = dateStr;

      // Options
      const container = document.getElementById('qv-options');
      container.innerHTML = '';
      
      product.options.forEach((option, idx) => {
          const group = document.createElement('div');
          group.className = 'qv-option-group';
          if(option.name === 'Title' && option.values[0] === 'Default Title') group.classList.add('hidden');

          const header = document.createElement('div');
          header.className = 'qv-option-header';
          header.innerHTML = `${option.name}: <span class="qv-active-val" id="opt-txt-${idx}">-</span>`;
          group.appendChild(header);

          const row = document.createElement('div');
          row.className = 'qv-swatch-container';
          option.values.forEach(val => {
              const btn = document.createElement('div');
              btn.className = 'qv-swatch-rect';
              btn.textContent = val;
              btn.dataset.value = val;
              btn.dataset.index = idx;
              btn.onclick = () => selectOption(idx, val);
              row.appendChild(btn);
          });
          group.appendChild(row);

          container.appendChild(group);
      });

      // Select First Available
      const firstAvailable = product.variants.find(v => v.available) || product.variants[0];
      if(firstAvailable) updateVariant(firstAvailable);

      modal.querySelector('.qv-loading').style.display = 'none';
      modal.querySelector('.qv-body').style.display = 'flex';
  }

  function selectOption(idx, val) {
      const group = document.querySelectorAll('.qv-option-group')[idx];
      const txt = document.getElementById(`opt-txt-${idx}`);
      if(txt) txt.textContent = val;

      group.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
      const btn = group.querySelector(`.qv-swatch-rect[data-value="${CSS.escape(val)}"]`);
      if(btn) btn.classList.add('selected');

      // Resolve Variant
      const selectedMap = {};
      document.querySelectorAll('.qv-option-group').forEach((g, i) => {
          if(g.classList.contains('hidden')) {
              selectedMap[i] = "Default Title"; 
          } else {
              const sel = g.querySelector('.selected');
              if(sel) selectedMap[i] = sel.dataset.value;
          }
      });

      const matched = currentProduct.variants.find(v => {
          return v.options.every((opt, i) => {
             const g = document.querySelectorAll('.qv-option-group')[i];
             if(g.classList.contains('hidden')) return true;
             return opt === selectedMap[i];
          });
      });

      if(matched) updateVariant(matched);
      else setUnavailable();
  }

  function updateVariant(variant) {
      document.getElementById('qv-variant-id').value = variant.id;
      
      const p = formatMoney(variant.price);
      const cp = variant.compare_at_price > variant.price ? formatMoney(variant.compare_at_price) : '';
      
      document.querySelectorAll('.qv-price').forEach(el => el.innerHTML = p);
      document.querySelectorAll('.qv-compare-price').forEach(el => el.innerHTML = cp);

      const btn = document.getElementById('qv-add-btn');
      if(variant.available) {
          btn.disabled = false; btn.textContent = "SEPETE EKLE";
      } else {
          btn.disabled = true; btn.textContent = "TÜKENDİ";
      }

      variant.options.forEach((val, idx) => {
          const txt = document.getElementById(`opt-txt-${idx}`);
          if(txt) txt.textContent = val;
          const group = document.querySelectorAll('.qv-option-group')[idx];
          if(!group.querySelector('.selected')) {
              const el = group.querySelector(`[data-value="${CSS.escape(val)}"]`);
              if(el) el.classList.add('selected');
          }
      });
      
      // Image update
      if(variant.featured_image) {
          let src = variant.featured_image.src;
          if(src.startsWith('//')) src = 'https:' + src;
          
          // Mobile Image logic
          document.getElementById('qv-mobile-image').src = src;

          // Desktop Slider logic
          const foundIdx = currentImages.findIndex(u => u.includes(src) || src.includes(u));
          if(foundIdx !== -1) {
             currentImageIndex = foundIdx;
             updateMainImage(foundIdx);
          } else {
             imgEl.src = src; 
          }
      }
  }

  function setUnavailable() {
      const btn = document.getElementById('qv-add-btn');
      btn.disabled = true; btn.textContent = "TÜKENDİ";
  }

  function formatMoney(cents) {
      let val = (cents / 100).toFixed(2);
      val = val.replace('.', ',');
      val = val.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
      return val + " TL";
  }

  // Cart
  document.getElementById('qv-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const btn = document.getElementById('qv-add-btn');
      const oldText = btn.textContent;
      btn.textContent = "EKLENİYOR..."; btn.disabled = true;

      const formData = new FormData(this);
      formData.append('quantity', 1);

      fetch('/cart/add.js', { method: 'POST', body: formData })
      .then(res => res.json())
      .then(() => {
          btn.textContent = "EKLENDİ!";
          setTimeout(() => {
              closeModal();
              document.documentElement.dispatchEvent(new CustomEvent('cart:refresh', { bubbles: true }));
              btn.textContent = oldText; btn.disabled = false;
          }, 800);
      })
      .catch((err) => {
          console.error(err);
          btn.textContent = "HATA";
          setTimeout(() => { btn.textContent = oldText; btn.disabled = false; }, 1000);
      });
  });

});
</script>
