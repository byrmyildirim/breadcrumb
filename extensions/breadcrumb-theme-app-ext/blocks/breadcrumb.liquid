{{ 'breadcrumb.css' | asset_url | stylesheet_tag }}

{%- assign t = template | split: '.' | first -%}
{%- assign sep = block.settings.separator -%}
{%- assign menu = linklists[block.settings.menu] -%}

<style>
  .breadcrumb-pro {
    padding: {{ block.settings.padding_y }}px {{ block.settings.padding_x }}px;
    margin-bottom: {{ block.settings.margin_bottom }}px;
    font-size: {{ block.settings.font_size }}px;
    background: {{ block.settings.bg_color }};
  }
  .breadcrumb-pro a { color: {{ block.settings.link_color }}; }
  .breadcrumb-pro .sep { color: {{ block.settings.sep_color }}; }
  .breadcrumb-pro .current { color: {{ block.settings.current_color }}; }
</style>

<nav class="breadcrumb-pro" aria-label="Breadcrumb">
  {%- comment -%} ALWAYS SHOW HOME {%- endcomment -%}
  <a href="/">
    {%- if block.settings.home_icon -%}
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:-2px">
        <path d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 0 .5-.5v-4h2v4a.5.5 0 0 0 .5.5H14a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.354 1.146zM2.5 14V7.707l5.5-5.5 5.5 5.5V14H10v-4a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v4H2.5z"/>
      </svg>
    {%- else -%}
      Anasayfa
    {%- endif -%}
  </a>
  <span class="sep">{{ sep }}</span>

  {%- case t -%}

    {%- when 'collection' -%}
      {%- assign custom_menu = shop.metafields.breadcrumb.custom_menu.value -%}
      {%- assign col_handle = collection.handle -%}
      {%- assign found = false -%}
      
      {%- if block.settings.use_app_menu and custom_menu != blank -%}
        {%- capture lookup_result -%}
          {%- render 'breadcrumb_lookup', menu: custom_menu, handle: col_handle, sep: sep -%}
        {%- endcapture -%}
        
        {%- if lookup_result contains '|||' -%}
          {%- assign parts = lookup_result | split: '|||' -%}
          {{ parts[1] }}
          {%- assign found = true -%}
        {%- endif -%}
      {%- endif -%}
      
      {%- unless found -%}
        {%- comment -%} Fallback to Standard Menu {%- endcomment -%}
        {%- for level1 in menu.links -%}
          {%- if level1.url == collection.url -%}{%- assign found = true -%}{%- break -%}{%- endif -%}
          {%- for level2 in level1.links -%}
            {%- if level2.url == collection.url -%}
              <a href="{{ level1.url }}">{{ level1.title }}</a><span class="sep">{{ sep }}</span>
              {%- assign found = true -%}
              {%- break -%}
            {%- endif -%}
            {%- for level3 in level2.links -%}
              {%- if level3.url == collection.url -%}
                <a href="{{ level1.url }}">{{ level1.title }}</a><span class="sep">{{ sep }}</span>
                <a href="{{ level2.url }}">{{ level2.title }}</a><span class="sep">{{ sep }}</span>
                {%- assign found = true -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
            {%- if found -%}{%- break -%}{%- endif -%}
          {%- endfor -%}
          {%- if found -%}{%- break -%}{%- endif -%}
        {%- endfor -%}
      {%- endunless -%}
      
      <span class="current">{{ collection.title }}</span>

    {%- when 'product' -%}
      {%- assign custom_menu = shop.metafields.breadcrumb.custom_menu.value -%}
      {%- assign best_depth = 0 -%}
      {%- assign final_path = "" -%}
      
      {%- if block.settings.use_app_menu and custom_menu != blank -%}
         {%- for col in product.collections -%}
           {%- capture lookup_result -%}
             {%- render 'breadcrumb_lookup', menu: custom_menu, handle: col.handle, sep: sep -%}
           {%- endcapture -%}
           
           {%- if lookup_result contains '|||' -%}
              {%- assign parts = lookup_result | split: '|||' -%}
              {%- assign depth = parts[0] | plus: 0 -%}
              {%- if depth > best_depth -%}
                {%- assign best_depth = depth -%}
                {%- assign final_path = parts[1] -%}
              {%- endif -%}
           {%- endif -%}
         {%- endfor -%}
      {%- endif -%}
      
      {%- if best_depth == 0 -%}
        {%- comment -%} Fallback Standard Menu {%- endcomment -%}
        {%- for col in product.collections -%}
          {%- assign col_url = col.url -%}
          {%- for level1 in menu.links -%}
            {%- if level1.url == col_url and best_depth < 1 -%}
              {%- assign best_depth = 1 -%}
              {%- capture final_path -%}<a href="{{ level1.url }}">{{ level1.title }}</a><span class="sep">{{ sep }}</span>{%- endcapture -%}
            {%- endif -%}
            {%- for level2 in level1.links -%}
              {%- if level2.url == col_url and best_depth < 2 -%}
                {%- assign best_depth = 2 -%}
                {%- capture final_path -%}<a href="{{ level1.url }}">{{ level1.title }}</a><span class="sep">{{ sep }}</span><a href="{{ level2.url }}">{{ level2.title }}</a><span class="sep">{{ sep }}</span>{%- endcapture -%}
              {%- endif -%}
              {%- for level3 in level2.links -%}
                {%- if level3.url == col_url and best_depth < 3 -%}
                  {%- assign best_depth = 3 -%}
                  {%- capture final_path -%}<a href="{{ level1.url }}">{{ level1.title }}</a><span class="sep">{{ sep }}</span><a href="{{ level2.url }}">{{ level2.title }}</a><span class="sep">{{ sep }}</span><a href="{{ level3.url }}">{{ level3.title }}</a><span class="sep">{{ sep }}</span>{%- endcapture -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
          {%- endfor -%}
        {%- endfor -%}
      {%- endif -%}
      
      {%- if best_depth > 0 -%}
        {{ final_path }}
      {%- elsif product.collections.size > 0 -%}
        <a href="{{ product.collections.first.url }}">{{ product.collections.first.title }}</a>
        <span class="sep">{{ sep }}</span>
      {%- endif -%}
      
      <span class="current">{{ product.title }}</span>

    {%- when 'blog' -%}
      <span class="current">{{ blog.title }}</span>

    {%- when 'article' -%}
      <a href="{{ blog.url }}">{{ blog.title }}</a>
      <span class="sep">{{ sep }}</span>
      <span class="current">{{ article.title }}</span>

    {%- when 'page' -%}
      <span class="current">{{ page.title }}</span>

    {%- else -%}
      <span class="current">{{ page_title }}</span>

  {%- endcase -%}
</nav>

{%- comment -%} SEO: JSON-LD Structured Data {%- endcomment -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Anasayfa",
      "item": "{{ shop.url }}"
    }
    {%- if t == 'product' and matched_col -%}
    ,{
      "@type": "ListItem",
      "position": 2,
      "name": "{{ matched_col.title | escape }}",
      "item": "{{ shop.url }}{{ matched_col.url }}"
    }
    ,{
      "@type": "ListItem",
      "position": 3,
      "name": "{{ product.title | escape }}",
      "item": "{{ shop.url }}{{ product.url }}"
    }
    {%- elsif t == 'collection' -%}
    ,{
      "@type": "ListItem",
      "position": 2,
      "name": "{{ collection.title | escape }}",
      "item": "{{ shop.url }}{{ collection.url }}"
    }
    {%- endif -%}
  ]
}
</script>

{% schema %}
{
  "name": "Breadcrumb Pro",
  "target": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "use_app_menu",
      "label": "Gelişmiş Uygulama Menüsünü Kullan",
      "default": true
    },
    {
      "type": "link_list",
      "id": "menu",
      "label": "Alternatif Menü",
      "default": "main-menu"
    },
    {
      "type": "text",
      "id": "separator",
      "label": "Ayırıcı",
      "default": "›"
    },
    {
      "type": "checkbox",
      "id": "home_icon",
      "label": "Anasayfa İkonu",
      "default": true
    },
    {
      "type": "range",
      "id": "font_size",
      "label": "Yazı Boyutu",
      "min": 10,
      "max": 20,
      "step": 1,
      "default": 14
    },
    {
      "type": "range",
      "id": "padding_x",
      "label": "Yatay Padding",
      "min": 0,
      "max": 40,
      "step": 5,
      "default": 0
    },
    {
      "type": "range",
      "id": "padding_y",
      "label": "Dikey Padding",
      "min": 0,
      "max": 40,
      "step": 5,
      "default": 10
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "label": "Alt Boşluk",
      "min": 0,
      "max": 40,
      "step": 5,
      "default": 15
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Arka Plan",
      "default": "transparent"
    },
    {
      "type": "color",
      "id": "link_color",
      "label": "Link Rengi",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "sep_color",
      "label": "Ayırıcı Rengi",
      "default": "#999999"
    },
    {
      "type": "color",
      "id": "current_color",
      "label": "Aktif Renk",
      "default": "#333333"
    }
  ]
}
{% endschema %}
