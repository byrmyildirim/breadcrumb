{%- comment -%}
  BREADCRUMB PRO - Hierarchical Breadcrumbs
  
  HOW IT WORKS:
  1. Reads the navigation menu you select in settings
  2. For product pages: finds which collection the product belongs to
  3. Traces the menu path back to find parent categories
  4. Displays: Home > Parent > Child > Product
  
  REQUIREMENTS:
  - Your navigation menu must have nested items (sub-menus)
  - Menu items must link to collections (not generic URLs)
  - Products must be assigned to the correct collections
{%- endcomment -%}

{%- assign t = template | split: '.' | first -%}
{%- assign sep = block.settings.separator -%}
{%- assign menu = linklists[block.settings.menu] -%}

<style>
  .breadcrumb-pro {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    gap: 0;
    padding: {{ block.settings.padding_y }}px {{ block.settings.padding_x }}px;
    margin-bottom: {{ block.settings.margin_bottom }}px;
    font-size: {{ block.settings.font_size }}px;
    background: {{ block.settings.bg_color }};
  }
  .breadcrumb-pro a {
    color: {{ block.settings.link_color }};
    text-decoration: none;
  }
  .breadcrumb-pro a:hover {
    text-decoration: underline;
  }
  .breadcrumb-pro .sep {
    margin: 0 8px;
    color: {{ block.settings.sep_color }};
  }
  .breadcrumb-pro .current {
    color: {{ block.settings.current_color }};
    font-weight: 600;
  }
</style>

<nav class="breadcrumb-pro" aria-label="Breadcrumb">
  {%- comment -%} ALWAYS SHOW HOME {%- endcomment -%}
  <a href="/">
    {%- if block.settings.home_icon -%}
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="vertical-align:-2px">
        <path d="M8.354 1.146a.5.5 0 0 0-.708 0l-6 6A.5.5 0 0 0 1.5 7.5v7a.5.5 0 0 0 .5.5h4.5a.5.5 0 0 0 .5-.5v-4h2v4a.5.5 0 0 0 .5.5H14a.5.5 0 0 0 .5-.5v-7a.5.5 0 0 0-.146-.354L13 5.793V2.5a.5.5 0 0 0-.5-.5h-1a.5.5 0 0 0-.5.5v1.293L8.354 1.146zM2.5 14V7.707l5.5-5.5 5.5 5.5V14H10v-4a.5.5 0 0 0-.5-.5h-3a.5.5 0 0 0-.5.5v4H2.5z"/>
      </svg>
    {%- else -%}
      Anasayfa
    {%- endif -%}
  </a>
  <span class="sep">{{ sep }}</span>

  {%- case t -%}

    {%- when 'collection' -%}
      {%- comment -%} COLLECTION PAGE: Find this collection in menu and show parents {%- endcomment -%}
      {%- assign found = false -%}
      
      {%- for level1 in menu.links -%}
        {%- if level1.url == collection.url -%}
          <span class="current">{{ collection.title }}</span>
          {%- assign found = true -%}
          {%- break -%}
        {%- endif -%}
        
        {%- for level2 in level1.links -%}
          {%- if level2.url == collection.url -%}
            <a href="{{ level1.url }}">{{ level1.title }}</a>
            <span class="sep">{{ sep }}</span>
            <span class="current">{{ collection.title }}</span>
            {%- assign found = true -%}
            {%- break -%}
          {%- endif -%}
          
          {%- for level3 in level2.links -%}
            {%- if level3.url == collection.url -%}
              <a href="{{ level1.url }}">{{ level1.title }}</a>
              <span class="sep">{{ sep }}</span>
              <a href="{{ level2.url }}">{{ level2.title }}</a>
              <span class="sep">{{ sep }}</span>
              <span class="current">{{ collection.title }}</span>
              {%- assign found = true -%}
              {%- break -%}
            {%- endif -%}
          {%- endfor -%}
          {%- if found -%}{%- break -%}{%- endif -%}
        {%- endfor -%}
        {%- if found -%}{%- break -%}{%- endif -%}
      {%- endfor -%}
      
      {%- unless found -%}
        <span class="current">{{ collection.title }}</span>
      {%- endunless -%}

    {%- when 'product' -%}
      {%- comment -%} 
        PRODUCT PAGE: 
        1. Check for Custom Menu Metafield (shop.metafields.breadcrumb.custom_menu.value)
        2. If exists, search THAT for deepest match (up to 6 levels)
        3. If not, fallback to Standard Menu
      {%- endcomment -%}
      
      {%- assign custom_menu = shop.metafields.breadcrumb.custom_menu.value -%}
      {%- assign best_depth = 0 -%}
      {%- assign path_html = "" -%}
      
      {%- if block.settings.use_app_menu and custom_menu != blank -%}
         {%- comment -%} --- CUSTOM MENU LOGIC (6 Levels) --- {%- endcomment -%}
         
         {%- for col in product.collections -%}
           {%- assign col_handle = col.handle -%}
           
           {%- for l1 in custom_menu -%}
             {%- if l1.handle == col_handle and best_depth < 1 -%}
                {%- assign best_depth = 1 -%}
                {%- capture path_html -%}
                   <a href="{{ l1.url }}">{{ l1.title }}</a>
                   <span class="sep">{{ sep }}</span>
                {%- endcapture -%}
             {%- endif -%}
             
             {%- if l1.children != blank -%}
               {%- for l2 in l1.children -%}
                 {%- if l2.handle == col_handle and best_depth < 2 -%}
                    {%- assign best_depth = 2 -%}
                    {%- capture path_html -%}
                       <a href="{{ l1.url }}">{{ l1.title }}</a>
                       <span class="sep">{{ sep }}</span>
                       <a href="{{ l2.url }}">{{ l2.title }}</a>
                       <span class="sep">{{ sep }}</span>
                    {%- endcapture -%}
                 {%- endif -%}
                 
                 {%- if l2.children != blank -%}
                   {%- for l3 in l2.children -%}
                     {%- if l3.handle == col_handle and best_depth < 3 -%}
                        {%- assign best_depth = 3 -%}
                        {%- capture path_html -%}
                           <a href="{{ l1.url }}">{{ l1.title }}</a>
                           <span class="sep">{{ sep }}</span>
                           <a href="{{ l2.url }}">{{ l2.title }}</a>
                           <span class="sep">{{ sep }}</span>
                           <a href="{{ l3.url }}">{{ l3.title }}</a>
                           <span class="sep">{{ sep }}</span>
                        {%- endcapture -%}
                     {%- endif -%}
                     
                     {%- if l3.children != blank -%}
                       {%- for l4 in l3.children -%}
                         {%- if l4.handle == col_handle and best_depth < 4 -%}
                            {%- assign best_depth = 4 -%}
                            {%- capture path_html -%}
                               <a href="{{ l1.url }}">{{ l1.title }}</a>
                               <span class="sep">{{ sep }}</span>
                               <a href="{{ l2.url }}">{{ l2.title }}</a>
                               <span class="sep">{{ sep }}</span>
                               <a href="{{ l3.url }}">{{ l3.title }}</a>
                               <span class="sep">{{ sep }}</span>
                               <a href="{{ l4.url }}">{{ l4.title }}</a>
                               <span class="sep">{{ sep }}</span>
                            {%- endcapture -%}
                         {%- endif -%}
                         
                         {%- if l4.children != blank -%}
                           {%- for l5 in l4.children -%}
                             {%- if l5.handle == col_handle and best_depth < 5 -%}
                                {%- assign best_depth = 5 -%}
                                {%- capture path_html -%}
                                   <a href="{{ l1.url }}">{{ l1.title }}</a>
                                   <span class="sep">{{ sep }}</span>
                                   <a href="{{ l2.url }}">{{ l2.title }}</a>
                                   <span class="sep">{{ sep }}</span>
                                   <a href="{{ l3.url }}">{{ l3.title }}</a>
                                   <span class="sep">{{ sep }}</span>
                                   <a href="{{ l4.url }}">{{ l4.title }}</a>
                                   <span class="sep">{{ sep }}</span>
                                   <a href="{{ l5.url }}">{{ l5.title }}</a>
                                   <span class="sep">{{ sep }}</span>
                                {%- endcapture -%}
                             {%- endif -%}

                             {%- if l5.children != blank -%}
                               {%- for l6 in l5.children -%}
                                 {%- if l6.handle == col_handle and best_depth < 6 -%}
                                    {%- assign best_depth = 6 -%}
                                    {%- capture path_html -%}
                                       <a href="{{ l1.url }}">{{ l1.title }}</a>
                                       <span class="sep">{{ sep }}</span>
                                       <a href="{{ l2.url }}">{{ l2.title }}</a>
                                       <span class="sep">{{ sep }}</span>
                                       <a href="{{ l3.url }}">{{ l3.title }}</a>
                                       <span class="sep">{{ sep }}</span>
                                       <a href="{{ l4.url }}">{{ l4.title }}</a>
                                       <span class="sep">{{ sep }}</span>
                                       <a href="{{ l5.url }}">{{ l5.title }}</a>
                                       <span class="sep">{{ sep }}</span>
                                       <a href="{{ l6.url }}">{{ l6.title }}</a>
                                       <span class="sep">{{ sep }}</span>
                                    {%- endcapture -%}
                                 {%- endif -%}
                               {%- endfor -%}
                             {%- endif -%}

                           {%- endfor -%}
                         {%- endif -%}

                       {%- endfor -%}
                     {%- endif -%}

                   {%- endfor -%}
                 {%- endif -%}

               {%- endfor -%}
             {%- endif -%}
           {%- endfor -%}
         {%- endfor -%}
      
      {%- else -%}
        {%- comment -%} --- FALLBACK TO STANDARD SHOPIFY MENU (3 Levels) --- {%- endcomment -%}
        
        {%- for col in product.collections -%}
          {%- assign col_url = col.url -%}
          {%- for level1 in menu.links -%}
            {%- if level1.url == col_url and best_depth < 1 -%}
              {%- assign best_depth = 1 -%}
              {%- capture path_html -%}<a href="{{ level1.url }}">{{ level1.title }}</a><span class="sep">{{ sep }}</span>{%- endcapture -%}
            {%- endif -%}
            {%- for level2 in level1.links -%}
              {%- if level2.url == col_url and best_depth < 2 -%}
                {%- assign best_depth = 2 -%}
                {%- capture path_html -%}<a href="{{ level1.url }}">{{ level1.title }}</a><span class="sep">{{ sep }}</span><a href="{{ level2.url }}">{{ level2.title }}</a><span class="sep">{{ sep }}</span>{%- endcapture -%}
              {%- endif -%}
              {%- for level3 in level2.links -%}
                {%- if level3.url == col_url and best_depth < 3 -%}
                  {%- assign best_depth = 3 -%}
                  {%- capture path_html -%}<a href="{{ level1.url }}">{{ level1.title }}</a><span class="sep">{{ sep }}</span><a href="{{ level2.url }}">{{ level2.title }}</a><span class="sep">{{ sep }}</span><a href="{{ level3.url }}">{{ level3.title }}</a><span class="sep">{{ sep }}</span>{%- endcapture -%}
                {%- endif -%}
              {%- endfor -%}
            {%- endfor -%}
          {%- endfor -%}
        {%- endfor -%}
      
      {%- endif -%}
      
      {%- comment -%} Output result {%- endcomment -%}
      {%- if best_depth > 0 -%}
        {{ path_html }}
      {%- elsif product.collections.size > 0 -%}
        <a href="{{ product.collections.first.url }}">{{ product.collections.first.title }}</a>
        <span class="sep">{{ sep }}</span>
      {%- endif -%}
      
      <span class="current">{{ product.title }}</span>

    {%- when 'blog' -%}
      <span class="current">{{ blog.title }}</span>

    {%- when 'article' -%}
      <a href="{{ blog.url }}">{{ blog.title }}</a>
      <span class="sep">{{ sep }}</span>
      <span class="current">{{ article.title }}</span>

    {%- when 'page' -%}
      <span class="current">{{ page.title }}</span>

    {%- else -%}
      <span class="current">{{ page_title }}</span>

  {%- endcase -%}
</nav>

{%- comment -%} SEO: JSON-LD Structured Data {%- endcomment -%}
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Anasayfa",
      "item": "{{ shop.url }}"
    }
    {%- if t == 'product' and matched_col -%}
    ,{
      "@type": "ListItem",
      "position": 2,
      "name": "{{ matched_col.title | escape }}",
      "item": "{{ shop.url }}{{ matched_col.url }}"
    }
    ,{
      "@type": "ListItem",
      "position": 3,
      "name": "{{ product.title | escape }}",
      "item": "{{ shop.url }}{{ product.url }}"
    }
    {%- elsif t == 'collection' -%}
    ,{
      "@type": "ListItem",
      "position": 2,
      "name": "{{ collection.title | escape }}",
      "item": "{{ shop.url }}{{ collection.url }}"
    }
    {%- endif -%}
  ]
}
</script>

{% schema %}
{
  "name": "Breadcrumb Pro",
  "target": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "use_app_menu",
      "label": "Gelişmiş Uygulama Menüsünü Kullan",
      "default": true,
      "info": "İşaretlenirse, Breadcrumb Pro uygulamasında oluşturduğunuz özel menü yapısı kullanılır. İşaretlenmezse aşağıdaki seçili menü kullanılır."
    },
    {
      "type": "link_list",
      "id": "menu",
      "label": "Alternatif Menü (Opsiyonel)",
      "default": "main-menu",
      "info": "Sadece yukarıdaki seçenek kapalıysa veya özel menü boşsa kullanılır."
    },
    {
      "type": "text",
      "id": "separator",
      "label": "Ayırıcı",
      "default": "›"
    },
    {
      "type": "checkbox",
      "id": "home_icon",
      "label": "Anasayfa İkonu Kullan",
      "default": true
    },
    {
      "type": "range",
      "id": "font_size",
      "label": "Yazı Boyutu (px)",
      "min": 10,
      "max": 20,
      "step": 1,
      "default": 14
    },
    {
      "type": "range",
      "id": "padding_x",
      "label": "Yatay Padding (px)",
      "min": 0,
      "max": 40,
      "step": 5,
      "default": 0
    },
    {
      "type": "range",
      "id": "padding_y",
      "label": "Dikey Padding (px)",
      "min": 0,
      "max": 40,
      "step": 5,
      "default": 10
    },
    {
      "type": "range",
      "id": "margin_bottom",
      "label": "Alt Boşluk (px)",
      "min": 0,
      "max": 40,
      "step": 5,
      "default": 15
    },
    {
      "type": "color",
      "id": "bg_color",
      "label": "Arka Plan Rengi",
      "default": "transparent"
    },
    {
      "type": "color",
      "id": "link_color",
      "label": "Link Rengi",
      "default": "#666666"
    },
    {
      "type": "color",
      "id": "sep_color",
      "label": "Ayırıcı Rengi",
      "default": "#999999"
    },
    {
      "type": "color",
      "id": "current_color",
      "label": "Aktif Sayfa Rengi",
      "default": "#333333"
    }
  ]
}
{% endschema %}
