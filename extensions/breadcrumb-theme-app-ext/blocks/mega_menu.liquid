<style>
    
/* ============================
   MEGA MENU – FULL OPTIMIZED STYLE
   ============================ */

/* ANA WRAPPER */
.mega-wrapper {
  width: 100%;
  position: relative;
  z-index: 40;
  overflow-x: hidden;
}


/* ============================
   ÜST MENÜ (ORTALANMIŞ)
   ============================ */
.mega-top {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0;
  padding: 14px 0;
}

.mega-top-item {
  position: relative;
  padding: 0 16px;
  font-size: 15px;
  font-weight: 400;
  cursor: pointer;
  text-decoration: none;
  color: #111;
}

.mega-top-item:hover {
  text-decoration: underline;
  color: #c0392b;
}

.mega-top-item.active {
  text-decoration: underline;
  color: #c0392b;
}

.mega-top-item:not(:last-child)::after {
  content: "";
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 1px;
  height: 16px;
  background-color: #ddd;
}

/* ============================
   MEGA PANEL
   ============================ */
.mega-panel {
  display: none;
  width: 100%;
  background: white;
  margin-top: 0;
  border: 1px solid #ddd;
  border-top: none;
  padding: 28px 0;
  box-shadow: 0 12px 25px rgba(0,0,0,0.12);
  position: relative;
  z-index: 999;
}

.mega-panel.active {
  display: block;
}


/* ============================
   GRID YAPI
   Sol: 28% görsel — Sağ: 72% kolonlar
   ============================ */
.mega-grid {
  width: 100%;
  margin: 0;
  display: grid;
  grid-template-columns: 28% 72%;
  gap: 40px;
  align-items: start;
  padding: 0 20px;
  box-sizing: border-box;
}


/* ============================
   SOL GÖRSEL — ABSOLUTE POSITION
   (Grid yüksekliğini BOZMAMASI için)
   ============================ */
.mega-image {
  position: relative;
  min-height: 280px;
}

.mega-image img {
  width: 100%;
  height: auto;
  position: absolute;
  top: 0;
  left: 0;
}


/* ============================
   SAĞ TARAF — 4 KOLON
   ============================ */
.mega-cols {
  display: grid;
  grid-template-columns: repeat(4, minmax(0,1fr));
  gap: 32px;
}


/* ============================
   KOLON (PARENT)
   ============================ */
.mega-col {
  margin: 0;
  padding: 0;
}


/* ============================
   PARENT BAŞLIK + ÇİZGİ
   ============================ */
.mega-col-title {
  font-weight: 600;
  font-size: 14px;
  color: #222;
  padding: 4px 0;
  border-bottom: 1px solid #e5e5e5;
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 0 0 4px 0;
  line-height: 1.2;
}

.mega-col-title a {
  color: #222;
  text-decoration: none;
}

.mega-col-title a:hover {
  text-decoration: underline;
}

/* OK İKONU */
.mega-col-title .arrow {
  font-size: 12px;
  margin-left: 6px;
  opacity: 0.7;
  cursor: pointer;
  transition: transform .2s ease;
}

.mega-col.open .arrow {
  transform: rotate(180deg);
}


/* ============================
   CHILD (ALT MENÜ) LİNKLERİ
   ============================ */
.mega-col-links {
  display: none;
  margin: 4px 0 0 0;
  padding: 0;
}

.mega-col-links a {
  display: block;
  text-decoration: none;
  color: #444;
  font-size: 14px;
  margin-bottom: 6px;
}

.mega-col-links a:hover {
  text-decoration: underline;
}


/* ============================
   AÇILMIŞ KOLON
   ============================ */
.mega-col.open .mega-col-links {
  display: block;
}

/* MOBİL GİZLEME */
@media (max-width: 768px) {
  .mega-wrapper {
    display: none !important;
  }
}

/* TEMA AKTİF STİLLERİNİ SIFIRLAMA - Bizim kontrolümüzde olsun */
{% if matched_parent %}
.mobile-category-bar li .menu-item span,
.mobile-category-bar li.active .menu-item span,
.category-bar li .menu-item span,
.category-bar li.active .menu-item span {
  color: inherit !important;
  font-weight: normal !important;
}
.mobile-category-bar li .menu-item img,
.mobile-category-bar li.active .menu-item img,
.category-bar li .menu-item img,
.category-bar li.active .menu-item img {
  filter: none !important;
}
/* Bizim aktif class'ımız */
.breadcrumb-active-category span {
  color: #e68b59 !important;
  font-weight: 700 !important;
}
.breadcrumb-active-category img {
  filter: invert(72%) sepia(35%) saturate(907%) hue-rotate(335deg) brightness(92%) contrast(89%) !important;
}
{% endif %}

</style>

{% assign mega_config = shop.metafields.breadcrumb.mega_menu_config.value %}
{% assign page_menu_map = shop.metafields.breadcrumb.page_menu_map.value %}
{% assign extra_menu_items = shop.metafields.breadcrumb.extra_menu_items.value %}
{% assign use_custom_root = block.settings.use_custom_root %}
{% assign auto_drill_down = block.settings.auto_context_root %}

{% assign nav_items = nil %}
{% assign matched_parent = nil %}

{% if use_custom_root %}
  {% assign custom_full_menu = shop.metafields.breadcrumb.custom_menu.value %}
  {% assign nav_items = custom_full_menu %}

  {% if auto_drill_down %}
    {% assign current_path = request.path | downcase %}
    {% assign found_mapping = nil %}
    
    {% comment %} 0. Product page: ALWAYS use product.collections first (priority) {% endcomment %}
    {% if template contains 'product' and product %}
      {% assign found_parent = nil %}
      {% for col in product.collections %}
        {% assign col_handle = col.handle %}
        {% for l1 in custom_full_menu %}
          {% if l1.handle == col_handle %}{% assign found_parent = l1 %}{% break %}{% endif %}
          {% for l2 in l1.children %}
            {% if l2.handle == col_handle %}{% assign found_parent = l1 %}{% break %}{% endif %}
            {% for l3 in l2.children %}
              {% if l3.handle == col_handle %}{% assign found_parent = l1 %}{% break %}{% endif %}
            {% endfor %}
            {% if found_parent %}{% break %}{% endif %}
          {% endfor %}
          {% if found_parent %}{% break %}{% endif %}
        {% endfor %}
        {% if found_parent %}{% break %}{% endif %}
      {% endfor %}
      {% if found_parent and found_parent.children.size > 0 %}
        {% assign nav_items = found_parent.children %}
        {% assign matched_parent = found_parent %}
      {% endif %}
    {% endif %}
    
    {% comment %} 1. Check manual page mappings (skip if product already matched) {% endcomment %}
    {% unless matched_parent %}
    {% for mapping in page_menu_map %}
       {% assign mapping_url = mapping.pageUrl | downcase %}
       {% assign mapping_url_clean = mapping_url | remove_first: '/' %}
       {% assign current_path_clean = current_path | remove_first: '/' %}
       
       {% if current_path_clean == mapping_url_clean %}
           {% assign found_mapping = mapping %}
           {% break %}
       {% elsif current_path contains mapping_url_clean and mapping_url_clean != '' and mapping_url_clean.size > 3 %}
           {% assign found_mapping = mapping %}
           {% break %}
       {% endif %}
    {% endfor %}
    {% endunless %}
    
    {% comment %} 2. If no manual mapping, use collection.handle to find parent in custom_menu (like breadcrumb) {% endcomment %}
    {% unless found_mapping %}
      {% if template contains 'collection' and collection %}
        {% assign col_handle = collection.handle %}
        {% assign found_parent = nil %}
        
        {% comment %} Search up to 6 levels deep in custom_menu to find collection {% endcomment %}
        {% for l1 in custom_full_menu %}
          {% comment %} Level 1 check {% endcomment %}
          {% if l1.handle == col_handle %}
            {% assign found_parent = l1 %}
            {% break %}
          {% endif %}
          
          {% if l1.children != blank %}
            {% for l2 in l1.children %}
              {% comment %} Level 2 check {% endcomment %}
              {% if l2.handle == col_handle %}
                {% assign found_parent = l1 %}
                {% break %}
              {% endif %}
              
              {% if l2.children != blank %}
                {% for l3 in l2.children %}
                  {% comment %} Level 3 check {% endcomment %}
                  {% if l3.handle == col_handle %}
                    {% assign found_parent = l1 %}
                    {% break %}
                  {% endif %}
                  
                  {% if l3.children != blank %}
                    {% for l4 in l3.children %}
                      {% comment %} Level 4 check {% endcomment %}
                      {% if l4.handle == col_handle %}
                        {% assign found_parent = l1 %}
                        {% break %}
                      {% endif %}
                      
                      {% if l4.children != blank %}
                        {% for l5 in l4.children %}
                          {% comment %} Level 5 check {% endcomment %}
                          {% if l5.handle == col_handle %}
                            {% assign found_parent = l1 %}
                            {% break %}
                          {% endif %}
                          
                          {% if l5.children != blank %}
                            {% for l6 in l5.children %}
                              {% comment %} Level 6 check {% endcomment %}
                              {% if l6.handle == col_handle %}
                                {% assign found_parent = l1 %}
                                {% break %}
                              {% endif %}
                            {% endfor %}
                          {% endif %}
                          {% if found_parent %}{% break %}{% endif %}
                        {% endfor %}
                      {% endif %}
                      {% if found_parent %}{% break %}{% endif %}
                    {% endfor %}
                  {% endif %}
                  {% if found_parent %}{% break %}{% endif %}
                {% endfor %}
              {% endif %}
              {% if found_parent %}{% break %}{% endif %}
            {% endfor %}
          {% endif %}
          {% if found_parent %}{% break %}{% endif %}
        {% endfor %}
        
        {% comment %} If found, use parent's children for menu {% endcomment %}
        {% if found_parent and found_parent.children.size > 0 %}
          {% assign nav_items = found_parent.children %}
          {% assign matched_parent = found_parent %}
        {% endif %}
      {% endif %}
    {% endunless %}
    
    {% comment %} 3. Apply found mapping {% endcomment %}
    {% if found_mapping and matched_parent == nil %}
        {% for item in custom_full_menu %}
            {% if item.title == found_mapping.menuTitle %}
                {% if item.children.size > 0 %}
                    {% assign nav_items = item.children %}
                    {% assign matched_parent = item %}
                {% endif %}
                {% break %}
            {% endif %}
        {% endfor %}
    {% endif %}
  {% endif %}

{% else %}
  {% assign nav_handle = block.settings.main_menu %}
  {% assign nav_items = linklists[nav_handle].links %}
{% endif %}


<div class="mega-wrapper" id="mega-{{ block.id }}">

  <!-- DEBUG: template='{{ template }}' collection='{{ collection.handle }}' nav_items.size={{ nav_items.size }} matched_parent='{{ matched_parent.title }}' use_custom_root={{ use_custom_root }} auto_drill_down={{ auto_drill_down }} -->

  <!-- ÜST MENÜ -->
  <div class="mega-top">
    {% for link in nav_items %}
      <a class="mega-top-item" 
         data-key="{{ link.title | handleize }}" 
         href="{{ link.url }}">
        {{ link.title }}
      </a>
    {% endfor %}
    
    {% comment %} EXTRA MENU ITEMS (from admin panel metafield) {% endcomment %}
    {% if extra_menu_items != blank %}
        {% for extra_item in extra_menu_items %}
            {% comment %} Find the menu item in custom_full_menu {% endcomment %}
            {% for menu_item in custom_full_menu %}
                {% if menu_item.title == extra_item.menuTitle %}
                    {% if extra_item.displayMode == 'parent' %}
                        {% comment %} Parent only - simple link, no dropdown {% endcomment %}
                        <a class="mega-top-item" 
                           href="{{ menu_item.url }}"
                           data-key="extra-{{ menu_item.title | handleize }}-parent">
                            {{ menu_item.title }}
                        </a>
                    {% else %}
                        {% comment %} Children mode - hoverable with dropdown {% endcomment %}
                        <a class="mega-top-item" 
                           data-key="extra-{{ menu_item.title | handleize }}" 
                           href="{{ menu_item.url }}">
                            {{ menu_item.title }}
                        </a>
                    {% endif %}
                    {% break %}
                {% endif %}
            {% endfor %}
        {% endfor %}
    {% endif %}
  </div>

  <!-- MEGA PANELS -->
  {% for link in nav_items %}
    
    {% assign sub_level_items = nil %}
    {% assign matching_config = nil %}
    
    {% if link.children.size > 0 %}
        {% assign sub_level_items = link.children %}
    {% endif %}

    {% for item in mega_config %}
      {% if item.triggerTitle == link.title %}
        {% assign matching_config = item %}
        
        {% unless sub_level_items %}
           {% if item.submenuHandle contains 'custom_special:' %}
              {% assign target_title = item.submenuHandle | remove: 'custom_special:' %}
              {% for c in custom_full_menu %}
                  {% if c.title == target_title %}{% assign sub_level_items = c.children %}{% endif %}
              {% endfor %}
           {% elsif item.submenuHandle != 'custom_menu_special' and item.submenuHandle != '' %}
              {% assign sub_level_items = linklists[item.submenuHandle].links %}
           {% endif %}
        {% endunless %}
        
        {% break %}
      {% endif %}
    {% endfor %}


    {% if sub_level_items.size > 0 %}
       
       {% comment %} Determine which image to use {% endcomment %}
       {% assign panel_image = nil %}
       {% if matching_config.imageUrl != blank %}
         {% assign panel_image = matching_config.imageUrl %}
       {% elsif block.settings.show_sidebar_image and block.settings.sidebar_image %}
         {% assign panel_image = block.settings.sidebar_image | image_url: width: 600 %}
       {% endif %}
       
       <div class="mega-panel" data-key="{{ link.title | handleize }}">
          <div class="mega-grid">
            
            <!-- SOL GÖRSEL (Her zaman görünür) -->
            <div class="mega-image">
              {% if panel_image %}
                <img src="{{ panel_image }}" alt="{{ link.title }}">
              {% endif %}
            </div>

            <!-- SAĞ: 4 KOLON -->
            <div class="mega-cols">
              {% for parent in sub_level_items %}
                <div class="mega-col">
                  
                  <div class="mega-col-title">
                    <a href="{{ parent.url }}">{{ parent.title }}</a>
                    
                    {% assign parent_children = parent.links | default: parent.children %}
                    {% if parent_children.size > 0 %}
                      <span class="arrow">▼</span>
                    {% endif %}
                  </div>
                  
                  {% if parent_children.size > 0 %}
                    <div class="mega-col-links">
                      {% for child in parent_children %}
                        <a href="{{ child.url }}">{{ child.title }}</a>
                      {% endfor %}
                    </div>
                  {% endif %}
                  
                </div>
              {% endfor %}
            </div>

          </div>
       </div>

    {% endif %}
  {% endfor %}
  
  {% comment %} PANELS FOR EXTRA MENU ITEMS (from admin panel) {% endcomment %}
  {% if extra_menu_items != blank %}
      {% for extra_item in extra_menu_items %}
          {% comment %} Create panel for ALL extra items with children {% endcomment %}
          {% for menu_item in custom_full_menu %}
              {% if menu_item.title == extra_item.menuTitle and menu_item.children.size > 0 %}
                  {% comment %} Use different data-key based on displayMode {% endcomment %}
                  {% if extra_item.displayMode == 'parent' %}
                      <div class="mega-panel" data-key="extra-{{ menu_item.title | handleize }}-parent">
                  {% else %}
                      <div class="mega-panel" data-key="extra-{{ menu_item.title | handleize }}">
                  {% endif %}
                      <div class="mega-grid">
                          {% comment %} Sol Görsel (genel ayardan) {% endcomment %}
                          <div class="mega-image">
                              {% if block.settings.show_sidebar_image and block.settings.sidebar_image %}
                                  <img src="{{ block.settings.sidebar_image | image_url: width: 600 }}" alt="{{ menu_item.title }}">
                              {% endif %}
                          </div>
                          
                          <div class="mega-cols">
                              {% for parent in menu_item.children %}
                                  <div class="mega-col">
                                      <div class="mega-col-title">
                                          <a href="{{ parent.url }}">{{ parent.title }}</a>
                                          {% if parent.children.size > 0 %}<span class="arrow">▼</span>{% endif %}
                                      </div>
                                      {% if parent.children.size > 0 %}
                                          <div class="mega-col-links">
                                              {% for child in parent.children %}
                                                  <a href="{{ child.url }}">{{ child.title }}</a>
                                              {% endfor %}
                                          </div>
                                      {% endif %}
                                  </div>
                              {% endfor %}
                          </div>
                      </div>
                  </div>
                  {% break %}
              {% endif %}
          {% endfor %}
      {% endfor %}
  {% endif %}

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const wrapper = document.getElementById("mega-{{ block.id }}");
  if (!wrapper) return;
  
  const topItems = wrapper.querySelectorAll(".mega-top-item");
  const panels = wrapper.querySelectorAll(".mega-panel");

  /* PANEL AÇMA */
  function openPanel(key) {
    panels.forEach(p => {
      p.classList.toggle("active", p.dataset.key === key);
    });
    topItems.forEach(item => {
      item.classList.toggle("active", item.dataset.key === key);
    });
  }

  topItems.forEach(item => {
    item.addEventListener("mouseenter", () => {
      openPanel(item.dataset.key);
    });
  });

  wrapper.addEventListener("mouseleave", () => {
    panels.forEach(p => p.classList.remove("active"));
    topItems.forEach(item => item.classList.remove("active"));
  });

  /* ALT MENÜ OK AÇ/KAPA */
  wrapper.querySelectorAll(".mega-col-title .arrow").forEach(arrow => {
    arrow.addEventListener("click", function (e) {
      e.preventDefault();
      e.stopPropagation();
      this.closest(".mega-col").classList.toggle("open");
    });
  });

  /* TEMA İKON MENÜSÜ AKTİF DURUMU (Web + Mobil) */
  {% if matched_parent %}
    function applyActiveMenuState() {
      const activeCategory = "{{ matched_parent.title | escape }}";
      const activeCategoryLower = activeCategory.toLowerCase();
      const firstWord = activeCategoryLower.split(' ')[0];
      
      console.log('[Mega Menu] Aktif kategori:', activeCategory, 'İlk kelime:', firstWord);
      
      // === 1. WEB MENÜSÜ (.menu-item) ===
      // Tüm li.active ve menu-item stillerini temizle
      document.querySelectorAll("li.active").forEach(li => {
        if (li.querySelector(".menu-item")) {
          li.classList.remove("active");
        }
      });
      
      document.querySelectorAll(".menu-item").forEach(item => {
        const spanText = item.querySelector("span");
        if (spanText) {
          spanText.style.color = "";
          spanText.style.fontWeight = "";
        }
        item.style.color = "";
        item.classList.remove("breadcrumb-active-category");
        const img = item.querySelector("img");
        if (img) {
          img.style.filter = "";
        }
      });
      
      // Doğru menu-item'ı bul ve vurgula
      document.querySelectorAll(".menu-item").forEach(item => {
        const spanText = item.querySelector("span");
        if (spanText) {
          const itemTitle = spanText.textContent.trim();
          const itemTitleLower = itemTitle.toLowerCase();
          
          const isMatch = (
            itemTitle === activeCategory ||
            activeCategoryLower.includes(itemTitleLower) ||
            itemTitleLower.includes(firstWord) ||
            (firstWord.length > 2 && firstWord.includes(itemTitleLower))
          );
          
          if (isMatch) {
            console.log('[Mega Menu] Web eşleşme bulundu:', itemTitle);
            const parentLi = item.closest("li");
            if (parentLi) {
              parentLi.classList.add("active");
            }
            item.classList.add("breadcrumb-active-category");
          }
        }
      });
      
      // === 2. MOBİL MENÜSÜ (.mobile-category-item) ===
      // Tüm mobile-category-item'lardan active kaldır
      document.querySelectorAll(".mobile-category-item").forEach(item => {
        item.classList.remove("active");
      });
      
      // Doğru mobile-category-item'ı bul ve vurgula
      let matchedHref = null;
      document.querySelectorAll(".mobile-category-item").forEach(item => {
        const spanText = item.querySelector("span");
        if (spanText) {
          const itemTitle = spanText.textContent.trim();
          const itemTitleLower = itemTitle.toLowerCase();
          
          const isMatch = (
            itemTitle === activeCategory ||
            activeCategoryLower.includes(itemTitleLower) ||
            itemTitleLower.includes(firstWord) ||
            (firstWord.length > 2 && firstWord.includes(itemTitleLower))
          );
          
          if (isMatch) {
            console.log('[Mega Menu] Mobil eşleşme bulundu:', itemTitle);
            item.classList.add("active");
            matchedHref = item.getAttribute("href");
          }
        }
      });
      
      // === 3. LOCALSTORAGE'I GÜNCELLE (Tema scriptini override et) ===
      if (matchedHref) {
        localStorage.setItem("lastMainCategory", matchedHref);
        console.log('[Mega Menu] localStorage güncellendi:', matchedHref);
      }
    }
    
    // Theme scripti DOMContentLoaded'da çalışıyor, biz ondan SONRA çalışmalıyız
    // Daha uzun gecikme kullan
    setTimeout(applyActiveMenuState, 400);
    setTimeout(applyActiveMenuState, 800);
    
    // Geri/ileri butonları ve bfcache için
    window.addEventListener('pageshow', function(event) {
      if (event.persisted) {
        console.log('[Mega Menu] Pageshow (bfcache) - yeniden uyguluyorum');
        setTimeout(applyActiveMenuState, 200);
      }
    });
  {% endif %}

});
</script>

{% schema %}
{
  "name": "Mega Menu (Pro)",
  "target": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "use_custom_root",
      "label": "Uygulama Özel Menüsünü Kullan",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "auto_context_root",
      "label": "Sayfa-Menü Eşleştirmelerini Kullan",
      "default": true,
      "info": "Admin panelinde tanımladığınız sayfa-menü eşleştirmelerini kullanır."
    },
    {
      "type": "link_list",
      "id": "main_menu",
      "label": "Ana Menü (Shopify)"
    },
    {
      "type": "text",
      "id": "extra_menu_handle",
      "label": "Ekstra Menü Handle",
      "info": "Ana kategorilerin yanına eklenecek menünün handle'ı (örn: extra-links). Shopify Admin > Online Store > Navigation'dan oluşturduğunuz menünün handle'ını yazın."
    },
    {
      "type": "header",
      "content": "Sol Görsel Ayarları"
    },
    {
      "type": "checkbox",
      "id": "show_sidebar_image",
      "label": "Sol Görsel Göster",
      "default": true
    },
    {
      "type": "image_picker",
      "id": "sidebar_image",
      "label": "Sol Görsel",
      "info": "Panel açıldığında sol tarafta görünecek resim"
    }
  ]
}
{% endschema %}
