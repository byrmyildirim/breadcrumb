<style>
/* ============================
   MEGA MENU – ADAPTIVE LAYOUT
   ============================ */

.mega-wrapper {
  width: 100%;
  position: relative;
  z-index: 40;
  background: white;
}

/* ÜST MENÜ */
.mega-top {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0;
  padding: 14px 0;
  border-bottom: 1px solid #eee;
}

.mega-top-item {
  position: relative;
  padding: 0 16px;
  font-size: 15px;
  font-weight: 500;
  cursor: pointer;
  text-decoration: none;
  color: #111;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.mega-top-item:hover {
  text-decoration: underline;
  color: #c0392b; /* Vurgu */
}
.mega-top-item:not(:last-child)::after {
  content: "";
  position: absolute;
  right: 0;
  top: 50%;
  transform: translateY(-50%);
  width: 1px;
  height: 14px;
  background-color: #ddd;
}

/* MEGA PANEL */
.mega-panel {
  display: none;
  width: 100%;
  background: white;
  margin-top: 1px;
  border-bottom: 1px solid #ddd;
  padding: 0;
  box-shadow: 0 12px 25px rgba(0,0,0,0.1);
  position: absolute;
  left: 0;
  z-index: 999;
}

.mega-panel.active {
  display: block;
}

/* ANA CONTAINER */
.mega-container {
  max-width: 1400px;
  margin: 0 auto;
  display: flex;
  min-height: 300px; /* Reduced min height */
}

/* SOL GÖRSEL */
.mega-sidebar-image {
  width: 25%;
  position: relative;
  border-right: 1px solid #eee;
  padding: 20px;
  display: flex;
  align-items: flex-start;
  justify-content: center;
}
.mega-sidebar-image img {
  max-width: 100%;
  height: auto;
  border-radius: 6px;
}

/* SAĞ İÇERİK */
.mega-content-area {
  width: 75%;
  display: flex;
  flex-direction: column;
}

/* ------ LAYOUT MODE: TABS (Deep Hierarchy) ------ */
.mega-mode-tabs .mega-tabs-header {
  display: flex;
  border-bottom: 1px solid #eee;
  background-color: #fcfcfc;
}

.mega-mode-tabs .mega-tab-item {
  padding: 16px 20px;
  font-size: 14px;
  font-weight: 600;
  color: #555;
  cursor: pointer;
  border-right: 1px solid #eee;
  background: #fdfdfd;
}
.mega-mode-tabs .mega-tab-item:hover { background: #f5f5f5; color: #000; }
.mega-mode-tabs .mega-tab-item.active {
  background: #fff;
  color: #d35400;
  border-bottom: 2px solid #d35400;
  margin-bottom: -1px;
}
.mega-mode-tabs .mega-tabs-body { padding: 24px; flex: 1; background: #fff; }
.mega-mode-tabs .mega-tab-content { display: none; }
.mega-mode-tabs .mega-tab-content.active { display: block; }


/* ------ LAYOUT MODE: SIMPLE GRID (Leaf Nodes) ------ */
.mega-mode-grid {
    padding: 30px;
    width: 100%;
}
.mega-simple-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 24px;
}
.mega-simple-header {
    font-weight: bold;
    font-size: 14px;
    margin-bottom: 8px;
    color: #222;
    padding-bottom: 4px;
    border-bottom: 1px solid #eee;
}

/* COMMON LINK STYLES */
.mega-sub-item a {
  display: block;
  font-size: 14px;
  color: #444;
  text-decoration: none;
  margin-bottom: 6px;
  padding: 2px 0;
}
.mega-sub-item a:hover {
  color: #d35400;
  text-decoration: underline;
}

/* MOBİL GİZLEME */
@media (max-width: 768px) {
  .mega-wrapper { display: none !important; }
}
</style>

{% assign mega_config = shop.metafields.breadcrumb.mega_menu_config.value %}
{% assign use_custom_root = block.settings.use_custom_root %}
{% assign auto_drill_down = block.settings.auto_context_root %}

{% assign nav_items = nil %}

{% if use_custom_root %}
  {% assign custom_full_menu = shop.metafields.breadcrumb.custom_menu.value %}
  {% assign nav_items = custom_full_menu %}

  {% if auto_drill_down %}
    {% comment %} --- CONTEXT AWARE LOGIC --- {% endcomment %}
    {% assign context_title = page.title | default: collection.title %}
    
    <!-- DEBUG: Context Title: '{{ context_title }}' -->
    
    {% for item in custom_full_menu %}
       <!-- DEBUG: Checking against: '{{ item.title }}' -->
       {% if item.title == context_title %}
           {% if item.children.size > 0 %}
               {% assign nav_items = item.children %}
               <!-- DEBUG: MATCH FOUND! Children count: {{ item.children.size }} -->
           {% else %}
               <!-- DEBUG: Match found but NO CHILDREN. -->
           {% endif %}
           {% break %}
       {% endif %}
    {% endfor %}
  {% endif %}

{% else %}
  {% assign nav_handle = block.settings.main_menu %}
  {% assign nav_items = linklists[nav_handle].links %}
{% endif %}


<div class="mega-wrapper" id="mega-{{ block.id }}">

  <!-- ÜST MENÜ LEVEL N -->
  <div class="mega-top">
    {% for link in nav_items %}
      <a class="mega-top-item" data-key="{{ link.title | handleize }}" href="{{ link.url }}">
        {{ link.title }}
      </a>
    {% endfor %}
  </div>

  <!-- PANELS -->
  {% for link in nav_items %}
    
    {% assign sub_level_items = nil %}
    {% assign matching_config = nil %}
    
    {% comment %} 1. Try to find children directly in the data (Custom Menu) {% endcomment %}
    {% if link.children.size > 0 %}
        {% assign sub_level_items = link.children %}
    {% endif %}

    {% comment %} 2. Find config for image and overrides (if any) {% endcomment %}
    {% for item in mega_config %}
      {% if item.triggerTitle == link.title %}
        {% assign matching_config = item %}
        <!-- Config Match Found: {{ item.submenuHandle }} -->
        
        {% unless sub_level_items %}
           {% comment %} If no direct children, try resolving from handle {% endcomment %}
           {% if item.submenuHandle contains 'custom_special:' %}
              {% assign target_title = item.submenuHandle | remove: 'custom_special:' %}
              {% assign custom_full_menu = shop.metafields.breadcrumb.custom_menu.value %}
              {% for c in custom_full_menu %}
                  {% if c.title == target_title %}{% assign sub_level_items = c.children %}{% endif %}
              {% endfor %}
           {% elsif item.submenuHandle != 'custom_menu_special' %}
              {% assign sub_level_items = linklists[item.submenuHandle].links %}
           {% endif %}
        {% endunless %}
        
        {% break %}
      {% endif %}
    {% endfor %}


    {% if sub_level_items.size > 0 %}
       
       {% comment %} --- DETERMINE LAYOUT MODE --- {% endcomment %}
       {% assign layout_mode = 'grid' %}
       {% for sub in sub_level_items %}
           {% if sub.children.size > 0 %}
               {% assign layout_mode = 'tabs' %}
               {% break %}
           {% endif %}
       {% endfor %}
       
       <div class="mega-panel" data-key="{{ link.title | handleize }}" data-lid="{{ link.id }}">
          <div class="mega-container">
            
            <!-- SIDEBAR IMAGE -->
            {% if matching_config.imageUrl != blank %}
            <div class="mega-sidebar-image">
                <img src="{{ matching_config.imageUrl }}" alt="">
            </div>
            {% endif %}

            <!-- CONTENT AREA -->
            <div class="mega-content-area mega-mode-{{ layout_mode }}" {% if matching_config.imageUrl == blank %}style="width:100%"{% endif %}>
                
                {% if layout_mode == 'tabs' %}
                    <!-- === TABS LAYOUT (Hierarchy) === -->
                     <div class="mega-tabs-header">
                        {% for parent in sub_level_items %}
                            <div class="mega-tab-item {% if forloop.first %}active{% endif %}" data-target="{{ link.title | handleize }}-t-{{ forloop.index }}">
                                {{ parent.title }}
                            </div>
                        {% endfor %}
                    </div>
                    <div class="mega-tabs-body">
                        {% for parent in sub_level_items %}
                            <div class="mega-tab-content {% if forloop.first %}active{% endif %}" id="{{ link.title | handleize }}-t-{{ forloop.index }}">
                                <div class="mega-simple-grid">
                                    {% assign sub_links = parent.links | default: parent.children %}
                                    {% for child in sub_links %}
                                        <div class="mega-sub-item"><a href="{{ child.url }}">{{ child.title }}</a></div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                
                {% else %}
                    <!-- === SIMPLE GRID LAYOUT (Flat) === -->
                     <div class="mega-mode-grid">
                        <div class="mega-simple-grid">
                            {% for parent in sub_level_items %}
                                <div class="mega-col">
                                    <div class="mega-simple-header"><a href="{{ parent.url }}" style="text-decoration:none; color:inherit;">{{ parent.title }}</a></div>
                                    <div class="mega-simple-links">
                                        {% assign sub_links = parent.links | default: parent.children %}
                                        {% for child in sub_links %}
                                            <div class="mega-sub-item"><a href="{{ child.url }}">{{ child.title }}</a></div>
                                        {% endfor %}
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                     </div>
                {% endif %}

            </div>
          </div>
       </div>

    {% endif %}
  {% endfor %}

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const wrapper = document.getElementById("mega-{{ block.id }}");
  if (!wrapper) return;

  const topItems = wrapper.querySelectorAll(".mega-top-item");
  const panels = wrapper.querySelectorAll(".mega-panel");

  // 1. OPEN PANEL ON HOVER
  topItems.forEach(item => {
    item.addEventListener("mouseenter", () => {
      panels.forEach(p => p.classList.remove("active"));
      const key = item.dataset.key;
      const targetPanel = wrapper.querySelector(`.mega-panel[data-key="${key}"]`);
      if (targetPanel) targetPanel.classList.add("active");
    });
  });

  wrapper.addEventListener("mouseleave", () => {
    panels.forEach(p => p.classList.remove("active"));
  });

  // 2. TABS SWITCHING
  wrapper.addEventListener("mouseover", (e) => {
    if (e.target.classList.contains("mega-tab-item")) {
        const tabItem = e.target;
        const targetId = tabItem.dataset.target;
        const contentArea = tabItem.closest(".mega-content-area");
        if (!contentArea) return;

        contentArea.querySelectorAll(".mega-tab-item").forEach(t => t.classList.remove("active"));
        contentArea.querySelectorAll(".mega-tab-content").forEach(c => c.classList.remove("active"));

        tabItem.classList.add("active");
        const targetContent = document.getElementById(targetId);
        if (targetContent) targetContent.classList.add("active");
    }
  });

});
</script>

{% schema %}
{
  "name": "Mega Menu (App)",
  "target": "section",
  "settings": [
    {
      "type": "checkbox",
      "id": "use_custom_root",
      "label": "Uygulama Özel Menüsünü Kullan",
      "default": false
    },
    {
       "type": "checkbox",
       "id": "auto_context_root",
       "label": "Otomatik Kök Menü (Sayfaya Göre)",
       "default": true,
       "info": "Eğer mevcut sayfa başlığı (örn. Bisiklet Sporu) menüde varsa, o menünün içine girer."
    },
    {
      "type": "link_list",
      "id": "main_menu",
      "label": "Ana Menü (Shopify)"
    }
  ]
}
{% endschema %}
