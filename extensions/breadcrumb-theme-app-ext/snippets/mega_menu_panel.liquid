{% comment %}
  Snippet: Mega Menu Panel
  Params:
  - link: The parent link object
  - sub_level_items: Collection of child items
  - matching_config: Custom config object for this item
  - block: The section block object
{% endcomment %}

{% if sub_level_items.size > 0 %}
  {% comment %} Determine which image to use {% endcomment %}
  {% assign panel_image = nil %}
  {% if matching_config.imageUrl != blank %}
    {% assign panel_image = matching_config.imageUrl %}
  {% elsif block.settings.show_sidebar_image and block.settings.sidebar_image %}
    {% assign panel_image = block.settings.sidebar_image | image_url: width: 600 %}
  {% endif %}
  
  <div class="mega-panel {{ block.settings.menu_design_style }}" data-key="{{ link.title | handleize }}">
    <div class="mega-grid {% unless panel_image %}no-image{% endunless %}">
      
      <!-- SOL GÖRSEL (Her zaman görünür) -->
      {% if panel_image %}
      <div class="mega-image">
          <img src="{{ panel_image }}" alt="{{ link.title }}">
      </div>
      {% endif %}

      <!-- SAĞ: 4 KOLON -->
      <div class="mega-cols">
        {% for parent in sub_level_items %}
          <div class="mega-col {% if block.settings.expand_submenus_default %}open{% endif %}">
            
            <div class="mega-col-title">
              <a href="{{ parent.url }}">{{ parent.title }}</a>
              
              {% assign parent_children = parent.links | default: parent.children %}
              {% if parent_children.size > 0 %}
                <span class="arrow">▼</span>
              {% endif %}
            </div>
            
            {% if parent_children.size > 0 %}
              <div class="mega-col-links">
                {% assign max_items = block.settings.max_visible_items | default: 5 %}
                {% assign hidden_count = 0 %}
                
                {% for child in parent_children %}
                  {% assign item_class = "" %}
                  {% if forloop.index > max_items %}
                    {% assign item_class = "hidden-item" %}
                    {% assign hidden_count = hidden_count | plus: 1 %}
                  {% endif %}
                  
                  <div class="mega-sub-item {{ item_class }}">
                    <a href="{{ child.url }}">{{ child.title }}</a>
                  </div>

                {% endfor %}
                
                {% if hidden_count > 0 %}
                  <button class="show-more-btn" type="button">Devamını Gör ({{ hidden_count }}) ▼</button>
                {% endif %}
              </div>
            {% endif %}
            
          </div>
        {% endfor %}
      </div>

    </div>
  </div>
{% endif %}
