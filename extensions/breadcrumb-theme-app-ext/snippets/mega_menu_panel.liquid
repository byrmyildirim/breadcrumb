{% comment %}
  Snippet: Mega Menu Panel
  Params:
  - link: The parent link object
  - sub_level_items: Collection of child items
  - matching_config: Custom config object for this item
  - block: The section block object
  - theme_settings: Global theme settings object (Optional)
  - custom_data_key: Optional override for the panel's data-key attribute
{% endcomment %}

{% if theme_settings %}
  {% assign use_style = theme_settings.menuStyle %}
  {% assign use_expand = theme_settings.expandSubmenus %}
  {% assign use_grandchild = theme_settings.showGrandchild %}
  {% assign use_max_items = theme_settings.maxVisibleItems %}
{% else %}
  {% assign use_style = block.settings.menu_design_style %}
  {% assign use_expand = block.settings.expand_submenus_default %}
  {% assign use_grandchild = block.settings.show_grandchild_menus %}
  {% assign use_max_items = block.settings.max_visible_items | default: 5 %}
{% endif %}

{% if sub_level_items.size > 0 %}
  {% comment %} Determine which image to use {% endcomment %}
  {% assign panel_image = nil %}
  {% if matching_config.imageUrl != blank %}
    {% assign panel_image = matching_config.imageUrl %}
  {% elsif block.settings.show_sidebar_image and block.settings.sidebar_image %}
    {% assign panel_image = block.settings.sidebar_image | image_url: width: 600 %}
  {% endif %}
  
  {% assign key_value = link.title | handleize %}
  {% if custom_data_key != blank %}
    {% assign key_value = custom_data_key %}
  {% endif %}
  
  <div class="mega-panel {{ use_style }}" data-key="{{ key_value }}">
    <div class="mega-grid {% unless panel_image %}no-image{% endunless %}">
      
      <!-- SOL GÖRSEL (Her zaman görünür) -->
      {% if panel_image %}
      <div class="mega-image">
          <img src="{{ panel_image }}" alt="{{ link.title }}">
      </div>
      {% endif %}

      <!-- SAĞ: 4 KOLON -->
      <div class="mega-cols">
        {% for parent in sub_level_items %}
          <div class="mega-col {% if use_expand %}open{% endif %}">
            
            <div class="mega-col-title">
              <a href="{{ parent.url }}">{{ parent.title }}</a>
              
              {% assign parent_children = parent.links | default: parent.children %}
              {% if parent_children.size > 0 %}
                <span class="arrow">▼</span>
              {% endif %}
            </div>
            
            {% if parent_children.size > 0 %}
              <div class="mega-col-links">
                {% assign hidden_count = 0 %}
                
                {% for child in parent_children %}
                  {% assign item_class = "" %}
                  {% if forloop.index > use_max_items %}
                    {% assign item_class = "hidden-item" %}
                    {% assign hidden_count = hidden_count | plus: 1 %}
                  {% endif %}
                  
                  <div class="mega-sub-item {{ item_class }}">
                    <a href="{{ child.url }}">{{ child.title }}</a>
                    
                    {% comment %} GRANDCHILDREN RENDER (3. SEVİYE) {% endcomment %}
                    {% if use_grandchild %}
                      {% assign grand_children = child.links | default: child.children %}
                      {% if grand_children.size > 0 %}
                        <div class="mega-grandchild-links">
                          {% for grand in grand_children %}
                             <a href="{{ grand.url }}">{{ grand.title }}</a>
                          {% endfor %}
                        </div>
                      {% endif %}
                    {% endif %}
                  </div>

                {% endfor %}
                
                {% if hidden_count > 0 %}
                  <button class="show-more-btn" type="button">Devamını Gör ({{ hidden_count }}) ▼</button>
                {% endif %}
              </div>
            {% endif %}
            
          </div>
        {% endfor %}
      </div>

    </div>
  </div>
{% endif %}
